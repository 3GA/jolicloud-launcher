#!/usr/bin/perl

$| = 1;
$0 = "jolicloud-launcher";

my $URL = "http://launcher.dev.jolicloud.org";
my $LOGDIR = "$ENV{'HOME'}/.cache";

( -d $LOGDIR ) || mkdir( $LOGDIR );

my ( $pid, @children );
open( STDOUT, ">>$LOGDIR/jolicloud-launcher.log" );


push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    open( STDERR, ">>$LOGDIR/jolicloud-daemon.log" );
    for ( ;; ) {
        print "jolicloud-daemon: launching...\n";
        system( "/usr/bin/jolicloud-daemon" );
        print "Got: $?\n";
        if ( $? == -1 ) {
            print "jolicloud-daemon: failed to execute: $!\n";
        }
        else {
            print "jolicloud-daemon: child exited with value %d\n",
                  $? >> 8;
        }
    }
    exit;
}

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    open( STDERR, ">>$LOGDIR/nickel-browser.log" );
    for ( ;; ) {
        print "nickel-browser: launching...\n";
        system( "/usr/bin/nickel-browser", "--app=$URL", "--desktop",
                "--no-default-browser-check", "--enable-logging=stderr",
                "--log-level=0" );
        if ( $? == -1 ) {
            print "nickel-browser: failed to execute: $!\n";
        }
        else {
            print "nickel-browser: child exited with value %d\n", 
                  $? >> 8;
        }
    }
    sleep(5);
    exit;
}


# If something happens to the main program, kill all the looping children

$SIG{ 'INT' } = \&reaper;
$SIG{ 'TERM' } = \&reaper;
$SIG{ 'KILL' } = \&reaper;
$SIG{ 'HUP' } = 'IGNORE';

foreach ( @children ) {
    waitpid( $_, 0 );
}


sub reaper
{
    warn "Killing: @children";
    kill( 15, @children );
}
