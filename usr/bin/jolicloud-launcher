#!/usr/bin/perl

use LWP;

$| = 1;
$0 = "jolicloud-launcher";

my $ONLINE_URL = "http://launcher.dev.jolicloud.org";
my $OFFLINE_URL = "http://localhost:8004";
my $LOGDIR = "/var/tmp";

( -d $LOGDIR ) || mkdir( $LOGDIR );

my ( $pid, @children );
open( STDOUT, ">>$LOGDIR/jolicloud-launcher.log" );


push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    open( STDERR, ">>$LOGDIR/jolicloud-daemon.log" );
    for ( ;; ) {
        if ( `pgrep -fl ^jolicloud-daemon` ) {
            sleep( 5 );
            next;
        }
        print "jolicloud-daemon: launching...\n";
        system( "/usr/bin/jolicloud-daemon", "-d" );
        if ( $? == -1 ) {
            print "jolicloud-daemon: failed to execute: $!\n";
        }
        else {
            printf "jolicloud-daemon: child exited with value %d\n",
                  $? >> 8;
        }
    }
    exit;
}

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    my $ua = LWP::UserAgent->new();
    open( STDERR, ">>$LOGDIR/nickel-browser.log" );

    for ( ;; ) {
        if ( `pgrep -fl nickel-browser | grep '\\-\\-desktop'` ) {
            sleep( 5 );
            next;
        }

        print "nickel-browser: launching...\n";

        # Do a generic ping of the ping URL. If it responds with error
        # status 400: NOT_LOGGED_IN we know we have internet access to the
        # jolicloud server.
        my $req = HTTP::Request->new( GET => "$ONLINE_URL/api/ping" );
        my $res = $ua->request( $req );
        my $url = $ONLINE_URL;
        unless ( $res->code eq 400 &&
             $res->content eq '{"error":{"code":"NOT_LOGGED_IN"}}' ) {
            # No internet access, display the internal offline URL.
            $url = $OFFLINE_URL;
        }

        system( "/usr/bin/nickel-browser", "--app=$url", "--desktop",
                "--no-default-browser-check", "--enable-logging=stderr",
                "--enable-ipv6", "--log-level=0" );
        if ( $? == -1 ) {
            print "nickel-browser: failed to execute: $!\n";
        }
        else {
            printf "nickel-browser: child exited with value %d\n", 
                  $? >> 8;
        }
    }
    exit;
}


# If something happens to the main program, kill all the looping children

$SIG{ 'INT' } = \&reaper;
$SIG{ 'TERM' } = \&reaper;
$SIG{ 'KILL' } = \&reaper;
$SIG{ 'HUP' } = 'IGNORE';

foreach ( @children ) {
    waitpid( $_, 0 );
}


sub reaper
{
    warn "Killing: @children";
    kill( 15, @children );
}
