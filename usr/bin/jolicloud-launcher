#!/usr/bin/perl

use LWP;
use Logger::Syslog;

$| = 1;
$0 = "jolicloud-launcher [main]";

# kill any remaining jolicloud-launcher from a previous session
opendir(PROC, "/proc");
@cmds = grep { /^\d+$/ && -f "/proc/$_/cmdline" } readdir(PROC);
closedir PROC;

foreach (@cmds) { # jolicloud-launcher [main]
    open(CMD,"/proc/$_/cmdline");
    $cmd = <CMD>;
    close CMD;
    chomp $cmd;
    if ($cmd eq $0 && $$ ne $_) {
        kill 15, $_;
    }
}

sleep 1;

foreach (@cmds) { # above ought to have killed any remaining jolicloud-daemon or nickel-browser but you never know
    open(CMD,"/proc/$_/cmdline");
    $cmd = <CMD>;
    close CMD;
    chomp $cmd;
    if ($cmd eq "jolicloud-daemon") {
        kill 15, $_;
    }
    elsif ($cmd =~ m|^/usr/lib/nickel-browser.*--desktop|) {
        kill 15, $_;
    }
}

sleep 1;

my $ONLINE_URL = "http://my.jolicloud.com";
my $OFFLINE_URL = "file:///usr/share/jolicloud-daemon/htdocs/index.html";

my @children;

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    close( STDOUT );
    close( STDERR );
    $0 = "jolicloud-launcher [jolicloud-daemon]";
    logger_prefix("jolicloud-daemon");
    for ( ;; ) {
        if ( `pgrep -fl ^jolicloud-daemon` ) {
            sleep( 5 );
            next;
        }
        notice( "launching" );
        system( "/usr/bin/jolicloud-daemon" );
        if ( $? == -1 ) {
            error( "failed to execute: $!" );
        }
        else {
            error( "child exited with value " . ( $? >> 8 ) );
        }
    }
    exit;
}

push( @children, fork );
if ( $children[ $#children ] == 0 ) {
    my $ua = LWP::UserAgent->new();
    close( STDOUT );
    close( STDERR );
    $0 = "jolicloud-launcher [nickel-browser]";
    logger_prefix("nickel-browser");

    $max_flag = "--start-maximized";
    open XDPYINFO, "xdpyinfo |";
    while (<XDPYINFO>) {
        if (/^ *dimensions:.+\((\d+)x(\d+) millimeters/) {
            $width = $1*0.03937 ;
            $height = $2*0.03937 ;
            $diag2 = $width*$width + $height*$height;
            notice ( "w: $width, h:$height, dÂ²:$diag2\n" );
            if ($diag2 > 169 ) { # 13" diag
                $max_flag = "--no-start-maximized";
            }
        }
    }
    close XDPYINFO;

    for ( ;; ) {
        if ( `pgrep -fl nickel-browser | grep '\\-\\-desktop'` ) {
            sleep( 5 );
            next;
        }

        notice( "launching" );

        # Do a generic ping of the ping URL. If it responds with error
        # status 400: NOT_LOGGED_IN we know we have internet access to the
        # jolicloud server.
        my $req = HTTP::Request->new( GET => "$ONLINE_URL/api/ping" );
        my $res = $ua->request( $req );
        my $url = $ONLINE_URL;
        unless ( $res->code eq 400 &&
             $res->content eq '{"error":{"code":"NOT_LOGGED_IN"}}' ) {
            # No internet access, display the internal offline URL.
            $url = $OFFLINE_URL;
        }

        system( "/usr/bin/nickel-browser", "--app=$url", "--desktop",
                "--no-default-browser-check",
                $max_flag,
                "--no-first-run", "--enable-ipv6" );
        if ( $? == -1 ) {
            error( "failed to execute: $!" );
        }
        else {
            error( "child exited with value " . ( $? >> 8 ) );
        }
    }
    exit;
}


# If something happens to the main program, kill all the looping children

$SIG{ 'INT' } = \&reaper;
$SIG{ 'TERM' } = \&reaper;
$SIG{ 'KILL' } = \&reaper;
$SIG{ 'HUP' } = 'IGNORE';

foreach ( @children ) {
    waitpid( $_, 0 );
}


sub reaper
{
    notice( "killing: " . join( ', ', @children ) );
    kill( 'TERM', @children );
}
